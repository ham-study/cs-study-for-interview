## 프로세스 동기화

한 프로세스가 다른 프로세스에게 영향을 주거나 받는 프로세스를 Cooperating process라고 한다. 반대로 아무런 영향을 미치지 않는 독립적인 프로세스는 Independent process이라고 한다. 현대 컴퓨터 환경에는 **Cooperating process과 다중 처리 시스템**이 주를 이루고 있기에 프로세스가 병렬로 실행될 때 여러 프로세스가 공유하는 데이터의 무결성이 유지되는 것에 대한 **동기화가 매우 중요**해 졌다. 이를 프로세스 동기화**(Process Synchronization)**라고 한다. (현재에는 대부분 쓰레드 기준으로 Switching을 하므로, Thread synchronization으로 많이 불린다.)


즉, 프로세스 동기화는 여러 프로세스가 동시에 하나의 공유된 자원에 접근하려고 할 때 이 프로세스들을 제어하여 **데이터의 일관성을 유지**시키는 것을 의미한다. 즉, 동기화가 잘 이루어 지지 않는다면 한 순간 여러 개의 스레드 또는 프로세스가 하나의 변수에 대한 값이 서로 다를 수 있다.

#### 프로세스 통신
1. 프로세스 내부 데이터 통신
	- 하나의 프로세스에 2개 이상의 스레드가 존재하는 경우의 통신
	- 전역변수 / 파일을 이용하여 데이터를 주고 받는다.
2. 프로세스간 데이터 통신
	- 같은 컴퓨터에 있는 여러 프로세스끼리 통신
	- 공용 파일 / 운영체제가 제공하는 파이프를 활용하여 데이터를 주고 받는다.
3. 네트워크를 이용한 데이터 통신
	- 여러 컴퓨터가 네트워크로 연결 되어 있을 때 프로세스간 통신
	- 소켓을 활용하여 데이터를 주고 받는다.
	- 원격 프로시저 호출 : 다른 컴퓨터에 있는 함수를 호출해주는 작업
    

### 공유자원
I/O 장치, 변수, 메모리, 파일 등 Task가 사용할 수 있는 모든 것을 우리는 자원이라 하고, 이 자원이 다른 Task에 의해서도 사용된다면 공유자원이라고 하게 된다. 

### 경쟁 상태(race condition)
공유 자원에 대해 여러 프로세스가 동시에 접근할 때, 자료의 일관성을 해치는 결과가 나타날 수 있는 상태

#### 경쟁 상태가 발생하는 경우 예시

- 커널 작업을 수행하는 중에 인터럽트 발생
- 프로세스가 System Call을 통해 커널 모드로 진입하여 작업을 수행하는 도중 문맥 교환이 발생할 때 
- 멀티 프로세서 환경에서 공유 메모리 내의 커널 데이터에 접근할 때

### 임계 구역(Critical section)
임계구역은 여러 개의 쓰레드가 수행되는 시스템에서 각 쓰레드들이 공유하는 데이터에 동시에 접근하는 작업이실행되는 코드 영역을 말한다.

#### 임계 구역 문제 해결을 위한 기본조건
1. 상호 배제 ( mutual exclusion )
	- 한 프로세스가 임계 구역에 들어가면, 다른 프로세스는 임계 구역에 들어 갈 수 없다는 원칙
2. 한정 대기 ( bounded waiting )
	- 어떤 프로세스도 무한 대기 상태에 있어선 안된다는 원칙
	- 기아상태를 방지하기 위해, 한 번 들어갔다 나온 프로세스는 다음에 들어갈 때 제한을 준다.
3. 진행의 융퉁성 ( progress flexibility )
	- 임계구역에 들어간 프로세스가 없다면, 어느 프로세스가 들어갈 것인지 적절히 선택해줘야 한다.
    - 이 선택은 무한정 연기되면 안된다.

### 피터슨 알고리즘
피터슨 알고리즘은 3가지 조건(상호 배제, 진행, 한정 대기) 를 만족시키기 위해 flag[]와 turn이라는 변수로 임계영역에 들어갈 프로세스(혹은 스레드)를 결정하는 방식이다. turn 변수는 어떤 프로세스/스레드가 critical section에 들어갈 차례인지 나타내는 변수이고, flag변수는 공유 자원을 쓰고 싶다라는 것을 표현하기 위한 변수이다.

#### 문제점
- 프로세스가 많이 몰리게 되면 critical section 앞의 while 문에서 계속 루프를 돌아야 하는 문제가 생기고 이를 **바쁜대기(Busy waiting)** 이라고 부른다.
- 현대 컴퓨터 아키텍쳐에서는 시스템 성능 향상을 위해 컴파일러가 읽기 및 쓰기 작업을 재배치 할 수 있기 때문에 피터슨 알고리즘이 보장된 작동을 하지 않을 수 있다.

### Spin lock
임계 구역에 진입이 불가능할 때 진입이 가능할 때까지 루프를 돌면서 재시도하는 방식으로 구현된 락을 의미한다. 임계 구역 진입 전까진 루프를 계속 돌고 있기 때문에 **busy waiting**이 발생한다.

스핀 락은 운영체제의 스케줄링 지원을 받지 않기 때문에, 해당 스레드에 대한 문맥 교환(context switch)이 일어나지 않는다.

### MUTEX
뮤텍스는 자원에 대한 접근을 동기화하기 위해 사용되는 상호배제(Mutual exclusion) 기술이다. 일종의 Locking 메커니즘으로 lock을 가진 하나의 쓰레드만이 임계구역에 접근할 수 있는것이다. 임계구역에서 작업이 끝난 쓰레드는 Unlock하여 lock을 반환한다. 상태가 0, 1로 이진 세마포어로 부르기도 한다.
ex) 화장실이 하나 뿐이 없는 식당

2가지 연산을 가지고 있다.
- wait 연산 : 자원을 획득하는 연산
- signal 연산 : 자원을 해제하는 연산

#### Spin lock 과의 차이
잠금 메커니즘이라는 점은 스핀 락과 동일하나 권한을 획득할 때까지 busy waiting 상태에 머무르지 않고 **sleep 상태(block)**로 들어가고 **wakeup **되면 다시 권한 획득을 시도하는 sleep lock을 사용

- block : 커널은 block을 호출한 프로세스를 suspend 시키고 이 프로세스의 PCB를 semaphore에 대한 wait queue에 넣는다.
- wakeup : block된 프로세스 P를 wakeup 시키고 이 프로세스의 PCB를 ready queue로 옮긴다.

### Semaphores(세마포)
소프트웨어상에서 Critical Section 문제를 해결하기 위한 **동기화 도구**를 말한다.
뮤텍스는 세마포어의 일종이며  binary semaphore뿐만 아니라 여러 상태를 가지는 counting semaphore도 존재한다. 

#### counting semaphore
가용한 자원의 개수로 초기화되며 자원을 사용하면 세마포어가 감소, 반납하면 세마포어가 증가합니다. 세마포가 0일 때는 모든 리소스가 사용하고 있기 때문에 누군가가 반납하기 전까지 waiting queue에서 대기한다. 세마포어의 변수만큼 프로세스가 접근할 수 있다. 
이렇기에 뮤텍스는 lock을 소유한 프로세스가 lock을 반납해야하지만 세마포어의 경우 다른 프로세스가 lock을 반납할수도 있다.

- wait 연산 : 세마포 감소
- signal 연산 : 세마포 증가

#### 단점
Deadlock(교착상태)
세마포가 Ready Queue 를 가지고 있고, 둘 이상의 프로세스가 Critical Section 진입을 무한정 기다리고 있고, Critical Section 에서 실행되는 프로세스는 진입 대기 중인 프로세스가 실행되야만 빠져나올 수 있는 상황을 지칭한다.

### 모니터
monitor는 공유 데이터와 critical section의 집합으로서 사용이 쉽기 때문에 deadlock등 error발생 가능성이 낮습니다. 다만, 지원하는 언어에서만 사용이 가능하고 OS가 컴파일러를 이해하고 있어야 critical section접근을 위한 코드를 생성합니다. 구조적인 특징은 entry queue와 signaler queue, condition queue가 존재합니다. 모니터에는 하나의 프로세스만이 진입이 가능합니다. 먼저 도착한 프로세스가 모니터로 들어가 공유 자원을 가지고 나오면 다른 프로세스가 모니터로 들어갑니다. 공유 자원이 없기 때문에 condition queue이동해서 대기하고 있습니다. 작업을 끝낸 프로세스는 모니터로 다시 들어와 공유 자원을 반납하고 signaler queue로 이동합니다. 그리고 condition queue에서 대기중인 프로세스를 깨우면 그 프로세스는 모니터에 들어가 공유 자원을 가지고 나갑니다. signaler queue에 있던 프로세스는 다시 모니터로 들어가 잔여 작업이 있다면 실행하는 방식으로 이뤄집니다.


