# COOKIE, SESSION, JWT

## COOKIE

- Stateless한 HTTP의 단점을 해소하고자 사용
- 브라우저에 저장되는 key와 value로 이루어진 데이터이다.
- 인증 유효시간을 설정할 수 있고, 유효 시간이 정해진다면 브라우저가 종료되어도 쿠키가 유지된다
- 브라우저에 총 300개의 쿠키 저장 가능
  - 하나의 도메인당 20개 저장 가능
  - 쿠키 하나당 4KB까지 저장 가능
- 응답 HTTP에 Set-Cookie 헤더를 추가하면 쿠키를 만들 수 있음
- 브라우저에서 자동으로 요청 HTTP 헤더에 쿠키를 추가함
- 구성 요소
  - 이름(Name) : 각각의 쿠키를 구별하는 데 사용되는 이름
  - 값(Value) : 쿠키의 이름과 관련된 값
  - 유효시간(Expires) : 쿠키의 유지시간
  - 도메인(Domain): 쿠키를 전송할 도메인
  - 경로(Path): 쿠키를 전송할 요청 경로
- 동작 방식
  1. 클라이언트가 로그인 요청
  2. 서버에서 쿠키 생성 후 클라이언트로 전달
  3. 클라이언트가 서버로 요청을 보낼 때 쿠키를 전송
  4. 쿠키를 이용해 유저 인증을 진행
- 단점
  - 용량이 작음 (최대 4KB)
  - 매 HTTP 요청마다 포함되어 데이터가 커질경우 서버에 부담을 줌
  - 평문으로 되어있어 보안에 취약함
    - 사용자 인증에 대한 정보를 모두 클라이언트가 가지고있게 되므로 HTTP요청을 탈취당할 경우 쿠키 자체를 탈취당해 사용자 정보를 모두 빼앗길수 있다.

## SESSION

- 세션은 쿠키를 기반으로 하지만 브라우저에 저장하는 쿠키와는 다르게 서버에 저장하여 관리
- 서버에서는 클라이언트를 구별하기 위해 각각의 세션ID를 브라우저 부여하게되며, 브라우저가 종료되기 전까지 유지한다.
- 동작 방식

  1. 클라이언트 인증 요청
     - 서버에서 세션ID 발급 -> 저장소에 세션ID와 사용자 데이터를 저장
     - 발급한 세션ID를 쿠키에 담아 응답
  2. 클라이언트는 세션ID가 담긴 쿠키를 헤더에 담아 서버에 요청
     - 서버는 세션ID를 보고 세션 저장소에서 찾음
     - 세션ID에 매핑된 사용자 데이터를 조회하고 응답

- 장점
  - 사용자 정보를 클라이언트에 저장해야하는 단일 쿠키 방식보다 보안에 유리함
  - 쿠키에는 세션ID만 저장하기때문에 탈취당해도 타격없음
- 단점
  - 사용자가 많아질수록 서버 메모리를 많이 차지함
  - 접속시마다 세션을 발급하고, 계속 관리해함
    - 동접자가 많아질수록 서버에 과부하를 일으킴

## JWT (Json Web Token)

<img width ='600' src = 'https://user-images.githubusercontent.com/71180414/142906985-c889fc38-c881-41eb-9bb8-cbd2a9154c7b.png'>

- 사용자 정보를 암호화시킨 토큰에 저장하는 방법
- URL-Safe 텍스트로 구성되기 때문에 HTTP 프로토콜의 어느 위치에든 들어갈 수 있음
  - 보통 HTTP 헤더에 넣는다
- json포맷을 사용하여 데이터를 저장
- 구성요소
  1. Header
     - Header는 두가지 종류의 Key값을 가진다
       - typ : 토큰타입
       - alg : 암호화 알고리즘 방식 / Signiture에 사용
  2. Payload
     - JWT를 통해 전달하고자 하는 데이터, Claim-Set이라고 함
     - JWT 자체는 암호화 된것이 아닌 인코딩된것이므로 민감정보를 포함하면 안된다
     - 세가지 종류의 Claim으로 구분
       - Public Claims : 사용자 정의 클레임 / 공개용 정보를 저장 (충돌 방지를 위해 URI 포맷 사용)
       - Private Claims : 사용자 정의 클레임 / 사용자 정보를 저장
       - Registered Claims : 미리 등록된 클레임 / 필수적으로 사용할 필요는 없지만 사용을 권고함
         - iss : 토큰을 발급한 발급자 (Issuer)
         - exp : 만료시간이 지난 토큰은 사용불가
         - nbf : Not Before의 의미로 해당 시간 이전에는 토큰 사용불가
         - iat : 토큰이 발급된 시각
         - jti : JWT ID로 토큰에 대한 식별자
  3. Signature
     - 토큰이 위변조되지 않았음을 증명함
     - Header 인코딩값 + Payload 인코딩값 -> 비밀키(secret)으로 해싱 -> base64 인코딩
- 동작 방식
  1. 클라이언트가 로그인 요청
  2. 서버에서 유저의 고유한 ID와 다른 인증 정보들과 함께 Payload에 담는다.
  3. JWT의 유효기간 설정 및 옵션을 설정해준다.
  4. Secret Key를 이용해 토큰을 발급한다.
  5. 발급된 토큰은 클라이언트에 쿠키 혹은 로컬스토리지 등에 저장하여 요청을 보낼 때마다 같이 보낸다.
  6. 서버는 토큰을 Secret Key로 복호화하여 검증하는 과정을 거친다.
  7. 검증이 완료되면 대응하는 데이터를 보내준다.
- 장점
  - Stateless한 상태를 지향하는 Rest API에 적합
  - 클라이언트가 정보를 가지고 있기에 세션처럼 별도의 저장소가 필요하지 않음
- 단점
  - 세션보다는 보안이 취약하다
    - 세션이 탈취당하면 해당 세션을 삭제하면 되지만
    - JWT가 탈취당하면 JWT는 유효기간이 끝날때까지 사용이 가능하기 때문에 보안이 취약하다
    - 따라서 유효기간을 짧게 설정하고 Refresh토큰을 사용한다
  - 다중 로그인 컨트롤, 사용자 유효성 체크, 강제 로그아웃 기능 구현이 어렵다
